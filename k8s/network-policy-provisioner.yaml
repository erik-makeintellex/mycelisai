apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-provisioner-strict
  namespace: mycelis
spec:
  podSelector:
    matchLabels:
      app: provisioner # The Forge
  policyTypes:
    - Egress
  egress:
    # Rule 1: Allow Talk to Kubernetes API (To spawn pods)
    - to:
        - ipBlock: # Assuming standard K8s service network, but user specified 10.96.0.1/32
            cidr: 10.96.0.1/32
      ports:
        - protocol: TCP
          port: 443

    # Rule 2: Allow Talk to NATS (To report status)
    - to:
        - podSelector:
            matchLabels:
              app: mycelis-core-nats # Adjusted to match standard Helm label if needed, assuming user's label 'app: nats' might be generic.
      ports:
        - protocol: TCP
          port: 4222

    # Rule 3: Allow DNS (Required for internal service discovery)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

  # IMPLICIT DENY: All other traffic (Internet, Other DBs) is BLOCKED.
