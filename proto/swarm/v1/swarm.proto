syntax = "proto3";

package mycelis.swarm.v1;

option go_package = "github.com/mycelis/core/pkg/pb/swarm";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/any.proto";

// -- Message Envelope --

enum MessageType {
  MESSAGE_TYPE_UNSPECIFIED = 0;
  MESSAGE_TYPE_EVENT = 1;
  MESSAGE_TYPE_TEXT = 2;
  MESSAGE_TYPE_BINARY = 3;
  MESSAGE_TYPE_TOOL_CALL = 4;
  MESSAGE_TYPE_TOOL_RESULT = 5;
}

message MsgEnvelope {
  string id = 1;
  google.protobuf.Timestamp timestamp = 2;
  string source_agent_id = 3;
  MessageType type = 4;
  
  // OneOf for strictly typed payloads
  oneof payload {
    EventPayload event = 5;
    TextPayload text = 6;
    ToolCallPayload tool_call = 7;
    ToolResultPayload tool_result = 8;
  }
  
  // Trace context for observability
  string trace_id = 10;
  string span_id = 11;

  // Team Routing: The logical group (e.g., "marketing", "sensors")
  string team_id = 14;

  // Context: Shared Key-Value state for swarm intelligence (AG2 Pattern)
  google.protobuf.Struct swarm_context = 15;
}

// -- Payloads --

message EventPayload {
  string event_type = 1; // e.g. "sensor.update", "task.complete"
  string stream_id = 2;
  google.protobuf.Struct data = 3; // Equivalent to Dict[str, Any]
}

message TextPayload {
  string content = 1;
  string recipient_id = 2; // For direct messaging
  string intent = 3;       // "ask", "reply", "inform"
  string context_id = 4;   // Thread ID
}

message ToolCallPayload {
  string call_id = 1;
  string tool_name = 2;
  google.protobuf.Struct arguments = 3;
}

message ToolResultPayload {
  string call_id = 1;
  google.protobuf.Struct result = 2;
  bool is_error = 3;
  string error_message = 4;
}

message AgentConfig {
  string name = 1;
  string role = 2;
  repeated string capabilities = 3;
  MessagingConfig messaging = 4;

  // The underlying power source. Defaults to "swarm:base" if empty.
  string source_uri = 5;
}

message MessagingConfig {
  repeated string inputs = 1;
  repeated string outputs = 2;
}

// -- Logging & Observability --

// Structural Log Entry for the central nervous system (The Cortex Memory)
message LogEntry {
  google.protobuf.Timestamp timestamp = 1; // Precise Time
  string trace_id = 2;                     // Workflow Thread
  string agent_id = 3;                     // Actor
  string team_id = 4;                      // Group
  string source_uri = 5;                   // Capability
  string intent = 6;                       // "process_image", "error", "startup"
  google.protobuf.Struct context_snapshot = 7; // State at moment of event
  string status = 8;                       // "SUCCESS", "FAILURE"
  string error_message = 9;                // Details
  google.protobuf.Any raw_payload = 10;    // Replay Data
}

// -- Governance & Approvals --

message ApprovalRequest {
  string request_id = 1;
  MsgEnvelope original_message = 2; // The suspended message
  string reason = 3;                // e.g. "Amount > $50"
  google.protobuf.Timestamp expires_at = 4;
}

message ApprovalSignal {
  string request_id = 1;
  bool approved = 2;
  string user_signature = 3; // "admin" or cryptographic signature
}
